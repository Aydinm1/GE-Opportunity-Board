(function () {
  // Optional: validate event.origin against an allowlist before handling messages.
  const IFRAME_ID = 'division-fixtures-iframe';
  const MIN_IFRAME_HEIGHT = 600;
  const MAX_IFRAME_HEIGHT = 1400;
  const log = (...args) => {
    try {
      console.log('[opportunityboard-parent]', ...args);
    } catch (_) {}
  };

  function postToSource(source, origin, payload) {
    try {
      source && source.postMessage(payload, origin);
      log('postToSource ok', { origin, type: payload?.type, id: payload?.id });
    } catch (_) {
      log('postToSource failed');
    }
  }

  window.addEventListener('message', async function (event) {
    const data = event.data || {};
    log('message received', { origin: event.origin, type: data?.type, data });
    if (!data || typeof data !== 'object' || !data.type) return;

    if (data.type === 'resize-iframe') {
      const iframe = document.getElementById(IFRAME_ID);
      const requestedHeight = Number(data.height) || 0;
      const clampedHeight = Math.min(MAX_IFRAME_HEIGHT, Math.max(MIN_IFRAME_HEIGHT, requestedHeight));
      if (iframe && requestedHeight > 0) {
        iframe.style.height = clampedHeight + 'px';
        log('resize-iframe applied', { iframeId: IFRAME_ID, requestedHeight, clampedHeight, min: MIN_IFRAME_HEIGHT, max: MAX_IFRAME_HEIGHT });
      } else {
        log('resize-iframe skipped', { iframeFound: !!iframe, requestedHeight, iframeId: IFRAME_ID });
      }
      return;
    }

    if (data.type === 'opportunityboard:get-parent-url') {
      log('replying with parent url', window.location.href);
      postToSource(event.source, event.origin, {
        type: 'opportunityboard:parent-url',
        id: data.id,
        url: window.location.href,
      });
      return;
    }

    if (data.type === 'opportunityboard:copy') {
      const text = String(data.text || '');
      let ok = false;
      let error = null;
      log('copy request received', { textLength: text.length, id: data.id });
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          ok = true;
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          ok = document.execCommand('copy');
          document.body.removeChild(ta);
        }
      } catch (err) {
        error = String(err);
        log('copy failed', { id: data.id, error });
      }
      log('copy result', { id: data.id, ok, error });
      postToSource(event.source, event.origin, {
        type: 'opportunityboard:copy-result',
        id: data.id,
        ok,
        error,
      });
      return;
    }

    if (data.type === 'opportunityboard:modal-open') {
      document.body.dataset.obPrevOverflow = document.body.style.overflow || '';
      document.body.dataset.obPrevTouchAction = document.body.style.touchAction || '';
      document.body.style.overflow = 'hidden';
      document.body.style.touchAction = 'none';
      log('modal-open applied');
      return;
    }

    if (data.type === 'opportunityboard:modal-close') {
      document.body.style.overflow = document.body.dataset.obPrevOverflow || '';
      document.body.style.touchAction = document.body.dataset.obPrevTouchAction || '';
      delete document.body.dataset.obPrevOverflow;
      delete document.body.dataset.obPrevTouchAction;
      log('modal-close applied');
    }
  });

  log('parent script initialized', { iframeId: IFRAME_ID, href: window.location.href });
})();
