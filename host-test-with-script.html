<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpportunityBoard Host Test — with parent script</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 1rem; }
    header { display:flex; align-items:center; gap:1rem; margin-bottom:1rem; }
    .controls { display:flex; gap:.5rem; align-items:center; }
    iframe { width:100%; border:1px solid #ddd; }
    #log { margin-top:1rem; max-height:320px; overflow:auto; background:#fafafa; border:1px solid #eee; padding:.5rem; font-size:13px; }
  </style>
  </head>
<body>
  <header>
    <div>
      <strong>Host test page (with parent script)</strong>
      <div style="font-size:12px;color:#555">Use this page to test the embedded OpportunityBoard iframe.<br/>Change the iframe src if needed.</div>
    </div>
    <div class="controls">
      <label for="src">iframe src:</label>
      <input id="src" type="text" size="40" value="http://localhost:3000" />
      <button id="load">Load iframe</button>
      <button id="set100vh">Set iframe height = 100vh</button>
    </div>
  </header>

  <div>
    <iframe id="division-fixtures-iframe" src="http://localhost:3000" style="height:600px;" loading="lazy" allow="clipboard-read; clipboard-write"></iframe>
  </div>

  <div id="log"></div>

          <!-- Debug parent script (paste this in the real host before </body>) -->
          <style>
            body.modal-locked { overflow: hidden; position: fixed; width: 100%; touch-action: none; }
            #division-fixtures-iframe { display:block; width:100%; border:0; }
          </style>

          <script>
          (function () {
            // CONFIG: replace with the iframe origin(s) allowed to post messages
            const ALLOWED = ['https://ge-opp-board.the.ismaili'];
            const IFRAME_ID = 'division-fixtures-iframe';
            const SHRINK_DELAY = 350;
            const MIN_DELTA = 8;

            // overlay debug logger
            const dbg = (function createLogger() {
              const el = document.createElement('div');
              Object.assign(el.style, {
                position: 'fixed', right: '12px', bottom: '12px', width: '360px', maxHeight: '40vh',
                overflow: 'auto', background: 'rgba(0,0,0,0.72)', color: '#fff', padding: '8px',
                fontSize: '12px', zIndex: 2147483647, borderRadius: '6px', boxSizing: 'border-box'
              });
              el.id = 'ob-host-debug';
              document.documentElement.appendChild(el);
              function logLine(...parts) {
                const d = document.createElement('div');
                d.textContent = new Date().toLocaleTimeString() + ' — ' + parts.map(p => {
                  try { return typeof p === 'string' ? p : JSON.stringify(p); } catch { return String(p); }
                }).join(' ');
                el.prepend(d);
                while (el.childNodes.length > 120) el.removeChild(el.lastChild);
                console.log('[OB host]', ...parts);
              }
              return logLine;
            })();

            function isAllowed(origin) { return ALLOWED.indexOf(origin) !== -1; }

            window.addEventListener('error', e => { try { dbg('UNCAUGHT ERROR', e.message || e.error || e); } catch {} });
            window.addEventListener('unhandledrejection', e => { try { dbg('UNHANDLED REJECTION', e.reason); } catch {} });

            function postToSource(src, origin, msg) { try { src && src.postMessage(msg, origin); dbg('POST ->', origin, msg); } catch (err) { dbg('POST FAILED', err && err.message); } }

            let lastHeight = 0; let shrinkTimer = null;

            window.addEventListener('message', async (event) => {
              dbg('MSG recv', { origin: event.origin, data: event.data });
              if (!isAllowed(event.origin)) { dbg('ignored origin', event.origin); return; }
              const data = event.data || {};
              if (!data || typeof data !== 'object' || !data.type) return;
              try {
                if (data.type === 'resize-iframe') {
                  const h = Number(data.height) || 0; if (h <= 0) { dbg('resize ignored 0'); return; }
                  const iframe = document.getElementById(IFRAME_ID); if (!iframe) { dbg('iframe not found', IFRAME_ID); return; }
                  if (h > lastHeight + MIN_DELTA) { iframe.style.height = h + 'px'; lastHeight = h; if (shrinkTimer) { clearTimeout(shrinkTimer); shrinkTimer = null; } dbg('iframe grew ->', h); }
                  else if (h < lastHeight - MIN_DELTA) { if (shrinkTimer) clearTimeout(shrinkTimer); shrinkTimer = setTimeout(() => { iframe.style.height = h + 'px'; lastHeight = h; shrinkTimer = null; dbg('iframe shrunk ->', h); }, SHRINK_DELAY); dbg('shrink scheduled ->', h); }
                  else { dbg('small delta ignored', { lastHeight, requested: h }); }
                  return;
                }
                if (data.type === 'opportunityboard:get-parent-url') { postToSource(event.source, event.origin, { type: 'opportunityboard:parent-url', id: data.id, url: window.location.href }); return; }
                if (data.type === 'opportunityboard:copy') {
                  const text = String(data.text || ''); let ok = false, errMsg = null;
                  try { if (navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(text); ok = true; } else { const ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.select(); ok = document.execCommand('copy'); document.body.removeChild(ta); } }
                  catch (err) { errMsg = String(err); dbg('copy error', errMsg); }
                  postToSource(event.source, event.origin, { type: 'opportunityboard:copy-result', id: data.id, ok, error: errMsg }); return;
                }
                if (data.type === 'opportunityboard:modal-open') { document.body.classList.add('modal-locked'); dbg('modal-open: host locked'); return; }
                if (data.type === 'opportunityboard:modal-close') { document.body.classList.remove('modal-locked'); dbg('modal-close: host unlocked'); return; }
                dbg('unhandled-message-type', data.type);
              } catch (err) {
                dbg('handler exception', err && err.message);
                postToSource(event.source, event.origin, { type: 'opportunityboard:host-error', error: String(err && err.stack || err && err.message || err) });
              }
            }, false);

            // runtime helper to add allowed origins while debugging
            window.__opportunityboardDebug = {
              addAllowed(origin) { if (ALLOWED.indexOf(origin) === -1) { ALLOWED.push(origin); dbg('added allowed origin', origin); } },
              removeAllowed(origin) { const i = ALLOWED.indexOf(origin); if (i !== -1) { ALLOWED.splice(i,1); dbg('removed allowed origin', origin); } }
            };

            dbg('opportunityboard host debug ready. Allowed:', ALLOWED);
          })();
          </script>

  <script>
    (function () {
      function log(...parts) {
        try {
          const out = parts.map(p => (typeof p === 'string' ? p : JSON.stringify(p))).join(' ');
          const el = document.getElementById('log');
          if (el) {
            const d = document.createElement('div');
            d.textContent = new Date().toLocaleTimeString() + ' — ' + out;
            el.appendChild(d);
            el.scrollTop = el.scrollHeight;
          }
          console.log('[host-test]', ...parts);
          if (window.__opportunityboardDebug) try { window.__opportunityboardDebug && window.__opportunityboardDebug.addAllowed; } catch {}
        } catch (e) { console.log('log error', e); }
      }

      const btnLoad = document.getElementById('load');
      const inSrc = document.getElementById('src');
      const iframe = document.getElementById('division-fixtures-iframe');
      const btn100 = document.getElementById('set100vh');

      if (btnLoad && inSrc && iframe) {
        btnLoad.addEventListener('click', function () {
          try {
            const v = String(inSrc.value || '').trim();
            if (!v) { log('no src provided'); return; }
            iframe.src = v;
            log('iframe src set to', v);
          } catch (err) { log('load click error', err && err.message); }
        }, false);
      } else {
        log('controls not found', { btnLoad: !!btnLoad, inSrc: !!inSrc, iframe: !!iframe });
      }

      if (btn100 && iframe) {
        btn100.addEventListener('click', function () {
          try {
            iframe.style.height = window.innerHeight + 'px';
            log('iframe height set to 100vh ->', iframe.style.height);
          } catch (err) { log('set100vh error', err && err.message); }
        }, false);
      }

      if (iframe) {
        iframe.addEventListener('load', function () { log('iframe loaded', iframe.src); }, false);
      }
    })();
  </script>

</body>
</html>
