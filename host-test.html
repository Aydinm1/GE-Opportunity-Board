<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpportunityBoard Host Test</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 1rem; }
    header { display:flex; align-items:center; gap:1rem; margin-bottom:1rem; }
    .controls { display:flex; gap:.5rem; align-items:center; }
    iframe { width:100%; border:1px solid #ddd; }
    #log { margin-top:1rem; max-height:320px; overflow:auto; background:#fafafa; border:1px solid #eee; padding:.5rem; font-size:13px; }
    .modal-locked { outline: 2px dashed rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <header>
    <div>
      <strong>Host test page</strong>
      <div style="font-size:12px;color:#555">Use this page to test the embedded OpportunityBoard iframe.<br/>Change the iframe src if needed.</div>
    </div>
    <div class="controls">
      <label for="src">iframe src:</label>
      <input id="src" type="text" size="40" value="http://localhost:3000" />
      <button id="load">Load iframe</button>
      <button id="set100vh">Set iframe height = 100vh</button>
    </div>
  </header>

  <div>
    <iframe id="division-fixtures-iframe" src="http://localhost:3000" style="height:600px;" loading="lazy" allow="clipboard-read; clipboard-write"></iframe>
  </div>

  <div id="log"></div>

  <script>
    (function(){
      const ALLOWED = ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://the.ismaili'];
      const iframe = document.getElementById('division-fixtures-iframe');
      const srcInput = document.getElementById('src');
      const loadBtn = document.getElementById('load');
      const set100 = document.getElementById('set100vh');
      const logEl = document.getElementById('log');

      function log(...args){
        const line = document.createElement('div');
        line.textContent = new Date().toLocaleTimeString() + ' â€” ' + args.map(a => (typeof a==='object' ? JSON.stringify(a) : String(a))).join(' ');
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }

      loadBtn.addEventListener('click', () => {
        iframe.src = srcInput.value;
        log('Loaded iframe', srcInput.value);
      });
      set100.addEventListener('click', () => {
        iframe.style.height = window.innerHeight + 'px';
        log('Forced iframe height to 100vh');
      });

      // Basic stable resize handler (grow immediately, shrink after delay)
      let lastHeight = 0; let shrinkTimeout = null;
      window.addEventListener('message', async (event) => {
        log('message', { origin: event.origin, data: event.data });
        if (!ALLOWED.includes(event.origin)) { log('ignored origin', event.origin); return; }
        const data = event.data || {};

        if (data.type === 'resize-iframe') {
          const requested = Number(data.height) || 0;
          log('resize requested', requested);
          if (Math.abs(requested - lastHeight) < 20) { log('ignore small fluct'); return; }
          if (requested > lastHeight) {
            lastHeight = requested;
            iframe.style.height = requested + 'px';
            log('iframe grown to', requested);
            if (shrinkTimeout) { clearTimeout(shrinkTimeout); shrinkTimeout = null; }
          } else {
            if (shrinkTimeout) clearTimeout(shrinkTimeout);
            shrinkTimeout = setTimeout(() => {
              lastHeight = requested;
              iframe.style.height = requested + 'px';
              log('iframe shrunk to', requested);
              shrinkTimeout = null;
            }, 300);
          }
          return;
        }

        if (data.type === 'opportunityboard:get-parent-url') {
          event.source.postMessage({ type: 'opportunityboard:parent-url', id: data.id, url: window.location.href }, event.origin);
          log('replied parent-url', window.location.href);
          return;
        }

        if (data.type === 'opportunityboard:copy') {
          try {
            await navigator.clipboard.writeText(data.text);
            event.source.postMessage({ type:'opportunityboard:copy-result', id: data.id, ok:true }, event.origin);
            log('copied via host', data.text);
          } catch (err) {
            event.source.postMessage({ type:'opportunityboard:copy-result', id: data.id, ok:false }, event.origin);
            log('host copy failed', err && err.message);
          }
          return;
        }

        if (data.type === 'opportunityboard:modal-open') {
          document.body.classList.add('modal-locked');
          log('modal open: locked host body');
          return;
        }
        if (data.type === 'opportunityboard:modal-close') {
          document.body.classList.remove('modal-locked');
          log('modal close: unlocked host body');
          return;
        }

      });

      // show initial info
      log('host-test ready. Allowed origins: ' + ALLOWED.join(', '));

    })();
  </script>
</body>
</html>
